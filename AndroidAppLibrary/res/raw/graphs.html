<html>
<head>
<script type="text/javascript" src="jquery_min.js"></script>
<script type="text/javascript" src="jquery_flot_min.js"></script>
<style type="text/css">
	.tickLabel { 
		color: #000;
		font-size: 10px; 
	}
</style>
<script type="text/javascript">
	options = {
		lines: {
			show: true
			, lineWidth: 2
			, fill: false
			
		}
		, bars: {
			show: false
		}
		, points: {
			show: false
		}
		, clickable: false
		, hoverable: false
		, shadowSize: 1
		, label: ""
		, legend: {
			show: false
		}
		, yaxis: {
			show: true
			, color: 'rgba(0,0,0,0)'
			, lines: false
			, min:0
		}
		, xaxis: {
			show: true
			, color: '#ffffff'
			, mode: 'time'
			, timeformat: "%d-%m"
		}
		, grid:{
			show: true
			, aboveData: true
			, borderWidth: 0
			, color: "#ffffff"
		}
	};

testdata = {
    "request": {
        "end_date": "2011-04-10",
        "start_date": "2011-04-01",
        "tests": [
            "downstream_mt",
            "upstream_mt",
            "latency",
            "packetloss"
        ],
        "unit_id": "5"
    },
    "results": {
        "downstream_mt": {
            "2011-04-02 00:00:00": "37.34",
            "2011-04-02 02:00:00": "36.14",
            "2011-04-02 04:00:00": "39.29",
            "2011-04-02 06:00:00": "38.51",
            "2011-04-02 08:00:00": "39.65",
            "2011-04-02 10:00:00": "39.32",
            "2011-04-02 12:00:00": "36.21",
            "2011-04-02 14:00:00": "36.16",
            "2011-04-02 16:00:00": "34.04",
            "2011-04-02 18:00:00": "38.29",
            "2011-04-02 20:00:00": "33.47",
            "2011-04-02 22:00:00": "35.19",
            "2011-04-03 00:00:00": "34.21",
            "2011-04-03 02:00:00": "39.03",
            "2011-04-03 04:00:00": "35.21",
            "2011-04-03 06:00:00": "36.20",
            "2011-04-03 08:00:00": "35.48"
        },
        "latency": {
            "2011-04-02 00:00:00": "23.41",
            "2011-04-02 01:00:00": "23.43",
            "2011-04-02 02:00:00": "23.45",
            "2011-04-02 03:00:00": "23.47",
            "2011-04-02 04:00:00": "23.47",
            "2011-04-02 05:00:00": "23.49",
            "2011-04-02 06:00:00": "23.48",
            "2011-04-02 07:00:00": "23.49",
            "2011-04-02 08:00:00": "23.49",
            "2011-04-02 09:00:00": "23.48",
            "2011-04-02 10:00:00": "23.48",
            "2011-04-02 11:00:00": "23.48",
            "2011-04-02 13:00:00": "23.52",
            "2011-04-02 14:00:00": "23.46",
            "2011-04-02 15:00:00": "23.48",
            "2011-04-02 16:00:00": "23.47",
            "2011-04-02 17:00:00": "23.48",
            "2011-04-02 18:00:00": "23.47",
            "2011-04-02 19:00:00": "23.46",
            "2011-04-02 20:00:00": "23.49",
            "2011-04-02 21:00:00": "23.45",
            "2011-04-02 22:00:00": "23.44",
            "2011-04-02 23:00:00": "23.44",
            "2011-04-03 00:00:00": "23.44",
            "2011-04-03 01:00:00": "23.42",
            "2011-04-03 02:00:00": "23.44",
            "2011-04-03 03:00:00": "23.45",
            "2011-04-03 04:00:00": "23.47",
            "2011-04-03 05:00:00": "23.50",
            "2011-04-03 06:00:00": "24.77",
            "2011-04-03 07:00:00": "30.24",
            "2011-04-03 08:00:00": "32.16",
            "2011-04-03 09:00:00": "32.17"
        },
        "packetloss": {
            "2011-04-02 00:00:00": "0.00",
            "2011-04-02 01:00:00": "0.00",
            "2011-04-02 02:00:00": "0.00",
            "2011-04-02 03:00:00": "0.00",
            "2011-04-02 04:00:00": "0.00",
            "2011-04-02 05:00:00": "0.00",
            "2011-04-02 06:00:00": "0.00",
            "2011-04-02 07:00:00": "0.00",
            "2011-04-02 08:00:00": "0.00",
            "2011-04-02 09:00:00": "0.00",
            "2011-04-02 10:00:00": "0.00",
            "2011-04-02 11:00:00": "0.00",
            "2011-04-02 13:00:00": "0.00",
            "2011-04-02 14:00:00": "0.00",
            "2011-04-02 15:00:00": "0.00",
            "2011-04-02 16:00:00": "0.00",
            "2011-04-02 17:00:00": "1.16",
            "2011-04-02 18:00:00": "0.00",
            "2011-04-02 19:00:00": "0.00",
            "2011-04-02 20:00:00": "0.00",
            "2011-04-02 21:00:00": "1.72",
            "2011-04-02 22:00:00": "0.00",
            "2011-04-02 23:00:00": "0.20",
            "2011-04-03 00:00:00": "0.00",
            "2011-04-03 01:00:00": "0.00",
            "2011-04-03 02:00:00": "0.00",
            "2011-04-03 03:00:00": "0.00",
            "2011-04-03 04:00:00": "0.00",
            "2011-04-03 05:00:00": "0.00",
            "2011-04-03 06:00:00": "0.00",
            "2011-04-03 07:00:00": "0.00",
            "2011-04-03 08:00:00": "0.38",
            "2011-04-03 09:00:00": "0.00"
        },
        "upstream_mt": {
            "2011-04-02 00:00:00": "35.55",
            "2011-04-02 02:00:00": "35.55",
            "2011-04-02 04:00:00": "34.70",
            "2011-04-02 06:00:00": "36.68",
            "2011-04-02 08:00:00": "36.40",
            "2011-04-02 10:00:00": "35.33",
            "2011-04-02 12:00:00": "36.26",
            "2011-04-02 14:00:00": "34.75",
            "2011-04-02 16:00:00": "34.74",
            "2011-04-02 18:00:00": "36.91",
            "2011-04-02 20:00:00": "37.08",
            "2011-04-02 22:00:00": "36.66",
            "2011-04-03 00:00:00": "35.36",
            "2011-04-03 02:00:00": "36.83",
            "2011-04-03 04:00:00": "36.59",
            "2011-04-03 06:00:00": "35.41",
            "2011-04-03 08:00:00": "14.21"
        },
    },
    "start_date" : "2011-04-01 00:00:00"
};





testdata = {
    "request": {
        "end_date": "2011-04-10",
        "start_date": "2011-04-01",
    },
    "results": {
        "mt": {
            "2011-04-02 00:00:00": "37.34",
            "2011-04-02 02:00:00": "36.14",
            "2011-04-02 04:00:00": "39.29",
            "2011-04-03 08:00:00": "35.48"
        },
    }
};

graphdata = 
{ "type":0,
  "y_label":"ms", 
   "end_date": "2011-04-10",
   "start_date": "2011-04-01",
   "results":[
   		{"datetime": "2011-04-02 00:00:00",   "value": "37.44"},
   		{"datetime": "2011-04-02 08:00:00",   "value": "7.44"}
   ]
   }


var plotter;

$(function(){
	if(!window.graphHandler){
		update();
	}
});

function log(message){
	try{
		window.graphHandler.log(message)
	}catch(err){
		console.log(message)
	}
}

function getTag(){
      try{
      log("js:getTag()"+window.graphHandler.getTag());
      return window.graphHandler.getTag();
      }catch (err){
            return 'upload';
      }
}

function getData(){
      log("js:getData()");
      try{
      log("js:"+window.graphHandler.getData())
    	  return JSON.parse(window.graphHandler.getData());
      }catch (err){
            return null;
      }
}

function getDateFormat(){
	  log("js:getDateFormat()");
  	  return window.graphHandler.getDateFormat();
}


function getStartDate(data){
      log("js:getStartDate()");
      try{
      		log("js:"+data['start_date']);
            return getDate(data['start_date'])
      }catch (err){
            return null;
      }
}

function getDate(key){
      log("js:getDate(" + key + ")");
    if (!isNaN(key)) {return key;}
    
	time = new Date(key).getTime();
	if (isNaN(time)){
		// Very cumbersome. Android v2.1-update does not support
		// the above conversion. We need to do it manually.
		
		key=key.replace("/","-");
		
            if(key.length == 10){
                  date = key.split('-');
                  date = new Date(date[0], date[1] - 1, date[2]);
            }else{
      		parts = key.split(' ');
      		date = parts[0].split('-');
                  time = parts[1].split(':');
                  date = new Date(date[0], date[1] - 1, date[2], time[0],time[1],time[2]);
            }
		time = date.getTime();
	}
	return time;
}

function parseData_OLD(data, tag){
      log("js:parseData()");
      new_data = [];
      for(key in data['results'][tag]){
            value = data['results'][tag][key];
            value = parseFloat(value);
            time = getDate(key);

            new_data.push([time, value]);
      }
      return new_data;
}

function parseData(data, tag){
    log("js:parseData()");
    new_data = [];
    mobile_data = [];
    wifi_data = [];
    for(key in data['results']){
        datetime='';
        value='';
        time='';
        type='';

  	  	  item = data['results'][key];
  	  	  value=item.value;
          time = getDate(item.datetime);
          type = item.graph_networktype;
          log("type" + type)
          if (type == 'WiFi') {
              wifi_data.push([time, value]);
          }
          else {
              mobile_data.push([time, value]);
          }
          //log ("time="+time+" value="+value+" type="+type);
    }
    new_data[0] = mobile_data;
    new_data[1] = wifi_data;
    log("newdata[0]" + new_data[0]);
    log("newdata[1]" + new_data[1]);
    
    return new_data;
}

function sortData(data){
	  if (typeof data != 'undefined') {
      	  log("js:sortData");
      	  data.sort(function(a, b){ return a[0] - b[0]; });
      }
      return data;
}

function fillData(data, start_date){
      log("js:fillData");
      log ("js:fillData sortData1");
      data = sortData(data);

      log("js:first_date");
      
      if (typeof data[0] === 'undefined') {
          log("js:BAIL OUT");
          return null;
      }
      first_date = data[0][0];
      
      log("js:start_date");
      start_date=Number(start_date);

      while (start_date < first_date){
      
      		//log("js: start_date="+start_date+" first_date="+first_date);
      		

            tmp = [start_date, 0];
            //log("js:pushing data"+tmp);
            data.push(tmp);
            start_date = start_date + (1000 * 60 * 60 * 24);
      }

      log ("js:fillData sortData2");
      data = sortData(data);
      return data;
}

function setLabel(tag){
      log("js:setLabel "+tag);
      function labelize(label) { document.getElementById('txt').innerHTML = label; }
      if(tag == 'upload'){
            labelize('Mbps');
      }else if(tag == 'download'){
            labelize('Mbps');
      }else if(tag == 'latency'){
            labelize('ms');
      }else if(tag == 'packetloss'){
            labelize('%');
      }else if(tag == 'jitter'){
			labelize('ms');    	  
      }
}

function setDateFormat(format){
	log("js:setDateFormat");
	options.xaxis.timeformat=format;
}

function update(){
      log("js:update");
	try{
            tag = getTag();
            
            data = getData();
            
            setDateFormat(getDateFormat());
            
            log("JS:data"+JSON.stringify(data));

            //data = graphdata; // dummy data!!   
            
            start_date = getStartDate(data);

            data = parseData(data, tag);
            mobile_data = fillData(data[0], start_date);
            wifi_data = fillData(data[1], start_date);

            if (mobile_data != null) {
            	mobile_data = { data: mobile_data, color: '#065496', fillColor: { colors: [ "rgba(79, 161, 203, 0.8)", "rgba(162,207,231,0.5)" ]}};
            }
            if (wifi_data != null) { 
            	wifi_data = { data: wifi_data, color: '#964806', fillColor: { colors: [ "rgba(203,121,79,0.8)", "rgba(69,0,231,0.5)" ]}};
            }
            

            setLabel(tag);
            if (mobile_data != null && wifi_data != null) {
                plotter = $.plot($('#plot'), [wifi_data, mobile_data], options);
            }
            else if(mobile_data != null) {
                plotter = $.plot($('#plot'), [mobile_data], options);
            }
            else if(wifi_data != null) {
                plotter = $.plot($('#plot'), [wifi_data], options);
            }
            else {
            	log("js:shouldn't get here");
            }
            
      }catch(err){
    	  	document.write("error "+err)
            log("js:Error: " + err);
      }
}

</script>
</head>
<body style="background: #DDDDDD; width:280px; height:120px; padding:0; margin:0; overflow:hidden;">
	<div id="txt" style="font-weight: bold; font-size:12px; padding:5px;margin-left: 2px;"></div>
	<div id="plot" style="position: absolute; width:260px; height:120px; padding:0; margin:0; margin-left:2px; margin-top:5px;"></div>
</body>
</html>